<!DOCTYPE html>
<html lang="en" class="dark transition duration-300">
<head>
  <meta charset="UTF-8">
  <title>Airsoft Tools</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          keyframes: {
            toastIn: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            },
            toastOut: {
              '0%': { opacity: '1', transform: 'translateY(0)' },
              '100%': { opacity: '0', transform: 'translateY(20px)' }
            }
          },
          animation: {
            'toast-in': 'toastIn 0.4s ease-out',
            'toast-out': 'toastOut 0.4s ease-in forwards'
          }
        }
      }
    };
  </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen flex flex-col items-center py-10 px-4 font-sans">

  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded shadow-md hidden z-50"></div>

  <!-- Sticky Bottom Action Bar -->
  <div class="fixed bottom-0 w-full bg-gray-800 dark:bg-gray-700 text-white p-3 z-50 shadow-lg flex justify-center gap-4 flex-wrap">
    <button onclick="calculateAll()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded transition">Calculate</button>
    <button onclick="downloadCSV()" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded transition">Download CSV</button>
    <button onclick="saveProfile()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded transition">Save Config</button>
  </div>

  <!-- Header & Dark Mode Toggle -->
  <div class="w-full max-w-4xl flex justify-between mb-6">
    <div class="flex gap-2 items-center">
      <select id="profileSelect" class="p-2 border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600">
        <option value="">-- Select Profile --</option>
      </select>
      <button onclick="loadProfile()" class="bg-blue-500 text-white px-3 py-1 rounded">Load</button>
      <button onclick="deleteProfile()" class="bg-red-500 text-white px-3 py-1 rounded">Delete</button>
    </div>
    <button id="darkModeToggle" class="bg-gray-300 dark:bg-gray-700 text-sm px-4 py-2 rounded hover:shadow transition">
      <span id="themeIcon">üåô</span>
    </button>
  </div>

  <!-- Calculator Container -->
  <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl p-8 w-full max-w-4xl">
    <h1 class="text-3xl font-bold text-center mb-8">üî´ Airsoft Ballistics & Hit Calculator</h1>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div>
        <label class="block font-semibold mb-1">Muzzle Velocity</label>
        <div class="flex gap-2 items-center">
          <input id="velocity" type="number" step="any" required class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600">
          <select id="unit" class="p-2 border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600">
            <option value="mps" selected>m/s</option>
            <option value="fps">FPS</option>
          </select>
        </div>
      </div>
      <div>
        <label class="block font-semibold mb-1">Energy (Joules)</label>
        <input id="energy" type="number" step="any" required class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600">
      </div>
      <div>
        <label class="block font-semibold mb-1">BB Weights (g)</label>
        <input id="weights" type="text" required class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600" placeholder="e.g. 0.20, 0.25, 0.28">
        <div class="flex gap-2 mt-2 text-sm">
          <button type="button" onclick="appendWeight('0.20')" class="bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">0.20g</button>
          <button type="button" onclick="appendWeight('0.25')" class="bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">0.25g</button>
          <button type="button" onclick="appendWeight('0.28')" class="bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">0.28g</button>
        </div>
      </div>
      <div>
        <label class="block font-semibold mb-1">Deviation Angle (¬∞)</label>
        <input id="deviation" type="number" step="0.1" class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600" value="1">
      </div>
      <div>
        <label class="block font-semibold mb-1">Wind Speed (m/s)</label>
        <input id="windSpeed" type="number" step="0.1" class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600" value="0">
      </div>
      <div>
        <label class="block font-semibold mb-1">Wind Direction (¬∞ from firing line)</label>
        <input id="windDir" type="number" step="0.1" class="w-full p-2 border rounded-md bg-white dark:bg-gray-700 dark:border-gray-600" value="90">
      </div>
    </div>
  </div>

  <!-- Results Section -->
  <div id="resultsContainer" class="mt-10 w-full max-w-4xl hidden">
    <canvas id="rangeChart" height="100"></canvas>
    <div class="overflow-x-auto mt-6 rounded-lg shadow">
      <table id="resultsTable" class="min-w-full border border-gray-300 dark:border-gray-600 text-sm text-center">
        <thead class="bg-gray-100 dark:bg-gray-700 font-semibold">
          <tr>
            <th class="px-4 py-2 border">BB Weight</th>
            <th class="px-4 py-2 border">Velocity (m/s)</th>
            <th class="px-4 py-2 border">Velocity (FPS)</th>
            <th class="px-4 py-2 border">Range (m)</th>
            <th class="px-4 py-2 border">Range (ft)</th>
            <th class="px-4 py-2 border">Hit %</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const icon = document.getElementById('themeIcon');
    document.getElementById("darkModeToggle").onclick = () => {
      const root = document.documentElement;
      const isDark = root.classList.toggle("dark");
      icon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
    };

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('hidden', 'animate-toast-out');
      toast.classList.add('animate-toast-in');
      setTimeout(() => {
        toast.classList.remove('animate-toast-in');
        toast.classList.add('animate-toast-out');
        setTimeout(() => toast.classList.add('hidden'), 400);
      }, 2500);
    }

    function appendWeight(val) {
      const input = document.getElementById("weights");
      const current = input.value;
      if (!current.includes(val)) input.value = current ? current + ", " + val : val;
    }

    function calculateAll() {
      const v = parseFloat(document.getElementById("velocity").value);
      const unit = document.getElementById("unit").value;
      const energy = parseFloat(document.getElementById("energy").value);
      const weightsRaw = document.getElementById("weights").value;
      const deviation = parseFloat(document.getElementById("deviation").value || 0);
      const windSpeed = parseFloat(document.getElementById("windSpeed").value || 0);
      const windDir = parseFloat(document.getElementById("windDir").value || 0);

      if (isNaN(v) || isNaN(energy) || !weightsRaw.trim()) {
        alert("Please fill in all required fields.");
        return;
      }

      const mps = unit === "fps" ? v * 0.3048 : v;
      const weights = weightsRaw.split(",").map(w => parseFloat(w.trim())).filter(Boolean);
      const timeToFall = Math.sqrt(2 / 9.81);
      const results = [];

      weights.forEach(w => {
        const velocityMps = Math.sqrt((2 * energy) / (w / 1000));
        const rangeM = velocityMps * timeToFall;
        const spreadPenalty = Math.min(1, (deviation / 10 + Math.abs(windSpeed * Math.cos(windDir * Math.PI / 180)) / 5));
        const hitProbability = Math.max(0, 100 - spreadPenalty * 100);

        results.push({
          weight: w.toFixed(2),
          mps: velocityMps.toFixed(2),
          fps: (velocityMps / 0.3048).toFixed(2),
          range_m: rangeM.toFixed(2),
          range_ft: (rangeM * 3.281).toFixed(2),
          hit: hitProbability.toFixed(0)
        });
      });

      renderResults(results);
      renderChart(results);
      document.getElementById("resultsContainer").classList.remove("hidden");
    }

    function renderResults(data) {
      const tbody = document.getElementById("resultsBody");
      tbody.innerHTML = "";
      data.forEach(row => {
        tbody.innerHTML += `
          <tr>
            <td class="border px-4 py-2">${row.weight}</td>
            <td class="border px-4 py-2">${row.mps}</td>
            <td class="border px-4 py-2">${row.fps}</td>
            <td class="border px-4 py-2">${row.range_m}</td>
            <td class="border px-4 py-2">${row.range_ft}</td>
            <td class="border px-4 py-2">${row.hit}%</td>
          </tr>
        `;
      });
    }

    let chart;
    function renderChart(data) {
      const ctx = document.getElementById("rangeChart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: data.map(d => `${d.weight}g`),
          datasets: [{ label: "Range (m)", data: data.map(d => d.range_m) }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: "Estimated Range by BB Weight" }
          }
        }
      });
    }

    function downloadCSV() {
      const rows = [["BB Weight (g)", "Velocity (m/s)", "Velocity (FPS)", "Range (m)", "Range (ft)", "Hit Probability (%)"]];
      document.querySelectorAll("#resultsBody tr").forEach(tr => {
        const cols = [...tr.children].map(td => td.textContent);
        rows.push(cols);
      });
      const csv = rows.map(r => r.join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "airsoft_ranges.csv";
      a.click();
    }

    function saveProfile() {
      const name = prompt("Enter a name for this config:");
      if (!name) return;
      const config = {
        velocity: document.getElementById("velocity").value,
        unit: document.getElementById("unit").value,
        energy: document.getElementById("energy").value,
        weights: document.getElementById("weights").value,
        deviation: document.getElementById("deviation").value,
        windSpeed: document.getElementById("windSpeed").value,
        windDir: document.getElementById("windDir").value
      };
      localStorage.setItem(`airsoft_${name}`, JSON.stringify(config));
      updateProfileDropdown();
      showToast("‚úÖ Config saved!");
    }

    function updateProfileDropdown() {
      const dropdown = document.getElementById("profileSelect");
      dropdown.innerHTML = "<option value=''>-- Select Profile --</option>";
      Object.keys(localStorage).forEach(key => {
        if (key.startsWith("airsoft_")) {
          const name = key.replace("airsoft_", "");
          const opt = document.createElement("option");
          opt.value = name;
          opt.innerText = name;
          dropdown.appendChild(opt);
        }
      });
    }

    function loadProfile() {
      const name = document.getElementById("profileSelect").value;
      if (!name) return;
      const config = JSON.parse(localStorage.getItem(`airsoft_${name}`));
      Object.entries(config).forEach(([k, v]) => {
        const el = document.getElementById(k);
        if (el) el.value = v;
      });
      showToast("üì¶ Profile loaded");
    }

    function deleteProfile() {
      const name = document.getElementById("profileSelect").value;
      if (!name) return;
      if (confirm(`Delete profile '${name}'?`)) {
        localStorage.removeItem(`airsoft_${name}`);
        updateProfileDropdown();
        showToast("üóëÔ∏è Profile deleted");
      }
    }

    window.onload = updateProfileDropdown;
  </script>
</body>
</html>
